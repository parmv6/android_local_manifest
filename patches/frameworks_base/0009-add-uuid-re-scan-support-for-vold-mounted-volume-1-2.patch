From 548268581369d1f39860b227e18d29de1072f846 Mon Sep 17 00:00:00 2001
From: Conn O'Griofa <connogriofa@gmail.com>
Date: Wed, 21 May 2014 05:47:09 +0100
Subject: [PATCH] Add UUID (re-)scan support for vold-mounted volume (1/2)

Consider the following scenario:
* Using physical primary only storage cofigurations with the sdcard
  daemon
* On first boot, the UUID is plumbed to the framework via vold, but this
  is only done when a volume is mounted (via the extractMetadata()
  function).
* When the framework crashes/restarts, vold does not need to mount any
  volumes (as the sdcard daemon will still be running), which means
  that the UUID is never plumbed to the framework upon restart.
* MediaProvider will continuously crash with an NPE due to the UUID being
  null.

Workaround the issue by adding "scanuuid" to the "vdc volume" command
list, and trigger a scan when the framework detects that a volume is
mounted but the UUID is null.

Change-Id: I01fceadf85dac97fbf19c41eb865abed714fe0f4
---
 services/java/com/android/server/MountService.java | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/services/java/com/android/server/MountService.java b/services/java/com/android/server/MountService.java
index c0906c9..1210d7c 100644
--- a/services/java/com/android/server/MountService.java
+++ b/services/java/com/android/server/MountService.java
@@ -772,6 +772,14 @@ class MountService extends IMountService.Stub
                         } else if (st == VolumeState.Mounted) {
                             state = Environment.MEDIA_MOUNTED;
                             Slog.i(TAG, "Media already mounted on daemon connection");
+                            if (volume.getUuid() == null) {
+                                Slog.i(TAG, "Scanning UUID");
+                                try {
+                                    mConnector.execute("volume", "scanuuid", path);
+                                } catch (NativeDaemonConnectorException ex) {
+                                    Slog.e(TAG, "Failed to scan UUID at " + path);
+                                }
+                            }
                         } else if (st == VolumeState.Shared) {
                             state = Environment.MEDIA_SHARED;
                             Slog.i(TAG, "Media shared on daemon connection");
-- 
1.9.3

